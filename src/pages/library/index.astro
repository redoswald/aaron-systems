---
import GardenLayout from '../../layouts/GardenLayout.astro';
import { getCollection } from 'astro:content';

// Fetch books and films
const books = await getCollection('books');
const films = await getCollection('films');

// Helper to get book cover (manual override or Open Library fallback)
function getBookCover(book: typeof books[0]): string {
  if (book.data.cover) return book.data.cover;
  if (book.data.isbn) {
    return `https://covers.openlibrary.org/b/isbn/${book.data.isbn}-L.jpg`;
  }
  return '/covers/books/placeholder.jpg';
}

// Helper to get film poster (manual override or TMDB)
async function getFilmCover(film: typeof films[0]): Promise<string> {
  if (film.data.cover) return film.data.cover;

  if (film.data.tmdbId) {
    const apiKey = import.meta.env.TMDB_API_KEY;
    if (apiKey) {
      try {
        const response = await fetch(
          `https://api.themoviedb.org/3/movie/${film.data.tmdbId}?api_key=${apiKey}`
        );
        const data = await response.json();
        if (data.poster_path) {
          return `https://image.tmdb.org/t/p/w500${data.poster_path}`;
        }
      } catch (e) {
        console.error('Failed to fetch TMDB poster:', e);
      }
    }
  }

  return '/covers/films/placeholder.jpg';
}

// Transform to grid items with date
const bookItems = books
  .map(book => ({
    title: book.data.title,
    subtitle: book.data.author,
    cover: getBookCover(book),
    href: `/library/books/${book.id}`,
    rating: book.data.rating,
    favorite: book.data.favorite,
    type: 'book' as const,
    date: book.data.dateRead,
  }));

const filmItems = await Promise.all(
  films.map(async (film) => ({
    title: film.data.title,
    subtitle: film.data.director,
    cover: await getFilmCover(film),
    href: `/library/films/${film.id}`,
    rating: film.data.rating,
    favorite: film.data.favorite,
    type: 'film' as const,
    date: film.data.dateWatched,
  }))
);

// Combine and sort by date
const allItems = [...bookItems, ...filmItems].sort((a, b) => b.date.valueOf() - a.date.valueOf());

// Group by year
const itemsByYear = allItems.reduce((acc, item) => {
  const year = item.date.getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(item);
  return acc;
}, {} as Record<number, typeof allItems>);

const years = Object.keys(itemsByYear).map(Number).sort((a, b) => b - a);

const counts = {
  all: allItems.length,
  books: bookItems.length,
  films: filmItems.length,
};
---

<GardenLayout title="Library" description="Books I've read and films I've watched." wide>
  <header class="mb-8">
    <h1 class="text-3xl mb-4" style="font-family: var(--font-serif);">Library</h1>
    <p class="text-[var(--text-secondary)]">
      Books I've read and films I've watched.
    </p>
  </header>

  <!-- Filter Tabs -->
  <div class="flex gap-2 mb-8" id="filter-tabs">
    <button class="filter-tab active" data-filter="all">
      All ({counts.all})
    </button>
    <button class="filter-tab" data-filter="book">
      Books ({counts.books})
    </button>
    <button class="filter-tab" data-filter="film">
      Films ({counts.films})
    </button>
  </div>

  <!-- Cover Grid by Year -->
  {allItems.length === 0 ? (
    <p class="text-[var(--text-muted)] py-12 text-center">
      No books or films added yet. Check back soon!
    </p>
  ) : (
    <div class="space-y-12">
      {years.map(year => (
        <section class="year-section" data-year={year}>
          <h2 class="text-2xl mb-6 text-[var(--text-primary)] border-b border-[var(--border)] pb-2" style="font-family: var(--font-serif);">
            {year}
          </h2>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
            {itemsByYear[year].map(item => (
              <a href={item.href} class="group library-item" data-type={item.type}>
                <div class="relative aspect-[2/3] mb-3 overflow-hidden rounded-lg shadow-sm group-hover:shadow-lg transition-all duration-200 bg-[var(--bg-secondary)]">
                  <img
                    src={item.cover}
                    alt={item.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"
                    loading="lazy"
                  />
                  {item.favorite && (
                    <span class="absolute top-2 right-2 text-yellow-400 drop-shadow-md text-lg">★</span>
                  )}
                  {item.rating && (
                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                      <span class="text-white text-lg">
                        {'★'.repeat(item.rating)}{'☆'.repeat(5 - item.rating)}
                      </span>
                    </div>
                  )}
                </div>
                <h3 class="text-sm font-medium text-[var(--text-primary)] line-clamp-2 group-hover:text-[var(--accent)] transition-colors">
                  {item.title}
                </h3>
                <p class="text-xs text-[var(--text-muted)] mt-0.5">{item.subtitle}</p>
              </a>
            ))}
          </div>
        </section>
      ))}
    </div>
  )}

  <!-- External Links -->
  <div class="mt-16 pt-8 border-t border-[var(--border)] flex flex-wrap gap-6 text-sm">
    <a
      href="https://goodreads.com/aaronoswald"
      target="_blank"
      rel="noopener noreferrer"
      class="text-[var(--text-muted)] hover:text-[var(--accent)] transition-colors"
    >
      Full reading list on Goodreads →
    </a>
    <a
      href="https://letterboxd.com/aaronoswald"
      target="_blank"
      rel="noopener noreferrer"
      class="text-[var(--text-muted)] hover:text-[var(--accent)] transition-colors"
    >
      Full film diary on Letterboxd →
    </a>
  </div>
</GardenLayout>

<script>
  const tabs = document.querySelectorAll('.filter-tab');
  const yearSections = document.querySelectorAll('.year-section');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const filter = tab.getAttribute('data-filter');

      // Update active tab
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      // Filter items and show/hide year sections
      yearSections.forEach(section => {
        const items = section.querySelectorAll('.library-item');
        let visibleCount = 0;

        items.forEach(item => {
          const type = item.getAttribute('data-type');
          if (filter === 'all' || type === filter) {
            (item as HTMLElement).style.display = '';
            visibleCount++;
          } else {
            (item as HTMLElement).style.display = 'none';
          }
        });

        // Hide year section if no visible items
        (section as HTMLElement).style.display = visibleCount > 0 ? '' : 'none';
      });
    });
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

---
import GardenLayout from '../../../layouts/GardenLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const films = await getCollection('films');
  return films.map((film) => ({
    params: { slug: film.id },
    props: { film },
  }));
}

const { film } = Astro.props;
const { Content } = await render(film);

// Get poster URL (manual override or TMDB API)
async function getFilmPoster(): Promise<string> {
  if (film.data.cover) return film.data.cover;

  if (film.data.tmdbId) {
    const apiKey = import.meta.env.TMDB_API_KEY;
    if (apiKey) {
      try {
        const response = await fetch(
          `https://api.themoviedb.org/3/movie/${film.data.tmdbId}?api_key=${apiKey}`
        );
        const data = await response.json();
        if (data.poster_path) {
          return `https://image.tmdb.org/t/p/w500${data.poster_path}`;
        }
      } catch (e) {
        console.error('Failed to fetch TMDB poster:', e);
      }
    }
  }

  return '/covers/films/placeholder.jpg';
}

const posterUrl = await getFilmPoster();

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    month: 'long',
    year: 'numeric'
  });
}
---

<GardenLayout title={film.data.title} description={`Review of ${film.data.title} (${film.data.year}) directed by ${film.data.director}`}>
  <article class="max-w-3xl mx-auto">
    <!-- Header with poster and metadata -->
    <header class="flex flex-col sm:flex-row gap-8 mb-12">
      <div class="shrink-0">
        <img
          src={posterUrl}
          alt={film.data.title}
          class="w-40 rounded-lg shadow-lg"
        />
      </div>
      <div class="flex-1">
        <div class="mb-3">
          <span class="tag tag-type">film</span>
          {film.data.favorite && (
            <span class="tag ml-2 bg-yellow-100 text-yellow-700">★ favorite</span>
          )}
        </div>
        <h1 class="text-2xl md:text-3xl mb-2" style="font-family: var(--font-serif);">
          {film.data.title}
          <span class="text-[var(--text-muted)] font-normal"> ({film.data.year})</span>
        </h1>
        <p class="text-lg text-[var(--text-secondary)] mb-4">
          Directed by {film.data.director}
        </p>

        <div class="flex flex-wrap items-center gap-4 text-sm text-[var(--text-muted)] mb-4">
          <span>Watched {formatDate(film.data.dateWatched)}</span>
          {film.data.rating && (
            <span class="text-yellow-500">
              {'★'.repeat(film.data.rating)}{'☆'.repeat(5 - film.data.rating)}
            </span>
          )}
        </div>

        {film.data.tags && film.data.tags.length > 0 && (
          <div class="flex gap-2 flex-wrap mb-4">
            {film.data.tags.map((tag: string) => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        )}

        {film.data.letterboxdUrl && (
          <a
            href={film.data.letterboxdUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="text-sm text-[var(--accent)] hover:text-[var(--accent-hover)] inline-flex items-center gap-1"
          >
            View on Letterboxd
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          </a>
        )}
      </div>
    </header>

    <!-- Review content -->
    <div class="prose">
      <Content />
    </div>

    <!-- Footer -->
    <footer class="mt-16 pt-8 border-t border-[var(--border)]">
      <a
        href="/library"
        class="text-sm text-[var(--accent)] hover:text-[var(--accent-hover)] inline-flex items-center gap-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to library
      </a>
    </footer>
  </article>
</GardenLayout>

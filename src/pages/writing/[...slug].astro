---
import GardenLayout from '../../layouts/GardenLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

function getPostType(id: string): string {
  if (id.includes('linkpost')) return 'linkpost';
  return 'essay';
}

const postType = getPostType(post.id);

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    month: 'long',
    day: 'numeric',
    year: 'numeric'
  });
}

// Filter to h2 and h3 headings for ToC
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);
const showToc = tocHeadings.length > 3;
---

<GardenLayout title={post.data.title} description={post.data.description} wide={showToc}>
  <div class:list={["relative", showToc && "xl:flex xl:gap-12"]}>
    <!-- Table of Contents - Mobile (top) -->
    {showToc && (
      <nav class="xl:hidden mb-8 p-4 bg-[var(--bg-secondary)] rounded-lg">
        <details class="group">
          <summary class="cursor-pointer text-sm font-medium text-[var(--text-secondary)] flex items-center justify-between">
            <span>Table of Contents</span>
            <svg class="w-4 h-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </summary>
          <ul class="mt-3 space-y-2">
            {tocHeadings.map(heading => (
              <li class:list={[heading.depth === 3 && "ml-4"]}>
                <a
                  href={`#${heading.slug}`}
                  class="text-sm text-[var(--text-muted)] hover:text-[var(--accent)] transition-colors"
                >
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </details>
      </nav>
    )}

    <!-- Main Article -->
    <article class="prose mx-auto flex-1 min-w-0">
      <header class="mb-12 not-prose">
        <div class="mb-4">
          <span class="tag tag-type">{postType}</span>
        </div>
        <h1 class="text-3xl md:text-4xl mb-4" style="font-family: var(--font-serif);">
          {post.data.title}
        </h1>
        <time class="text-[var(--text-muted)]">
          {formatDate(post.data.date)}
        </time>
        {post.data.tags && post.data.tags.length > 0 && (
          <div class="flex gap-2 mt-4 flex-wrap">
            {post.data.tags.map((tag: string) => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        )}
      </header>

      <Content />

      <footer class="mt-16 pt-8 border-t border-[var(--border)] not-prose">
        <a
          href="/writing"
          class="text-sm text-[var(--accent)] hover:text-[var(--accent-hover)] inline-flex items-center gap-2"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to all writing
        </a>
      </footer>
    </article>

    <!-- Table of Contents - Desktop (sidebar) -->
    {showToc && (
      <nav class="hidden xl:block w-56 shrink-0">
        <div class="sticky top-24">
          <p class="text-xs font-medium text-[var(--text-muted)] uppercase tracking-wide mb-3">
            On this page
          </p>
          <ul class="space-y-2 border-l border-[var(--border)]">
            {tocHeadings.map(heading => (
              <li class:list={[heading.depth === 3 && "ml-2"]}>
                <a
                  href={`#${heading.slug}`}
                  class:list={[
                    "block text-sm py-1 -ml-px border-l border-transparent pl-4 transition-colors",
                    "text-[var(--text-muted)] hover:text-[var(--text-primary)] hover:border-[var(--accent)]"
                  ]}
                >
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </nav>
    )}
  </div>
</GardenLayout>
